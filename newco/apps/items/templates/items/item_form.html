{% extends "site_base.html" %}

{% load url from future %}
{% load i18n %}
{% load bootstrap_tags %}
{% load staticfiles %}
{% load format_utils %}

{% block extra_head_base %}
  {{ block.super }}

  <script type="text/javascript" src="{% static 'admin/js/jquery.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'admin/js/jquery.init.js' %}"></script>

  {{ form.media }}
{% endblock %}

{% block head_title %}{% trans "Add a product" %}{% endblock %}

{% block body %}

<h1>{% block form_header %}{% if "question" in request.GET.next %}{% trans "Fill in some information about" %}{% trans ":" %} {{ item }}{% elif not item %}{% trans "Add a product" %}{% trans ":" %}{% else %}{% trans "Edit"%} {{ item }}{% trans ":"%}{% endif %}{% endblock %}</h1>
<br>

{% url 'faq' as faq %}

<button class="btn btn-mini btn-success " data-toggle="collapse" data-target="#item_form" style="z-index: 0 ;"><i class="icon-plus"></i>{% trans "Tips" %}</button>
<div id="item_form" class="collapse out">{% blocktrans with url=faq|add:"#tags" %}
  Here, you can create a new product page in 10 seconds. To do so, you need to:
  <ol>
    <li>Fill in the product name and its associated <b><a href="{{ url }}" class="black tooltip-top" title="Click here for help on tags">tags</a></b>.</li>
    <i class="icon-play"></i> You want to do more? <b>Add features!</b> You can:
    <li>Create the associated Store links using <em>Stores search</em>.</li>
    <li>Drag and drop the right corresponding images on the top positions, and trash the irrelevant ones.</li>
  </ol>
{% endblocktrans %}</div>

</br>

<form action="" method="POST">{% csrf_token %}
  <div class="row">
    <div class="span4">
      {{ form|as_bootstrap }}

      {% if item %}{% if item.affiliationitem_set.all %}<br><br>
        <h3>{% trans "Linked Products" %}</h3>
        <div class="row"><div class="span3">
          <button type="submit" class="btn pull-right" name="remove_links"><i class="icon-remove-sign"></i> {% trans "Remove unselected" %}</button>
        </div></div>
        {% for i in item.affiliationitem_set.all %}
          <div class="row"><div >
            <div class="span2">{% include "affiliation/_affiliation_item.html" with prod=i %}</div>
            <div class="span1"><span style="vertical-align:-30px"><input type="checkbox" name="linked_aff" value="{{ i.id }}" checked></span></div>
          </div></div>
        {% endfor %}
      {% endif %}{% endif %}
    </div>
    <div class="span8" id="search_store" data-store="1">{% if item %}
      <button type="submit" class="btn" name="store_search"><i class="icon-eye-open" id="item_test" data-item="1"></i> {% trans "Stores Search" %}</button>
      {% if form.product_list_by_store %}
        <button type="submit" class="btn" name="add_links"><i class="icon-plus-sign"></i> {% trans "Add selected" %}</button><br><br>
        {% for store, product_list in form.product_list_by_store.items %}{% if product_list %}{% cycle 1 0 as row silent %}{% if row %}<div class="row">{% endif %}<div class="span4"><div class="thumbnail row">
          <h3><a href="{{ product_list.0.store.url }}" target="_blank" class="black">{% with "https://getfavicon.appspot.com/"|add:product_list.0.store.url as icon_url %}<img src="{{ icon_url }}" height="24px" width="24px">&nbsp;{{ product_list.0.store }}{% endwith %}</a></h3>
          {% for i in product_list %}<div class="row">
            <input type="hidden" name="current_search_{{ store }}" value="{{ i.id }}"/>
            <div class="span1"><input type="checkbox" name="link_aff" value="{{ i.id }}">&nbsp;<img src="{{ i.img_small }}" width="50px" height="50px"></div>
            <div class="span2"><a href="{{ i.url }}" class="black" target="_blank">{{ i.name }}</a></div>
            <div class="span1"><a href="{{ i.url }}" target="_blank">{% price i.price i.currency LANGUAGE_CODE %}</a></div>
          </div>{% endfor %}
        </div></div>{% if not row %}</div>{% endif %}{% endif %}{% if row and forloop.last %}</div>{% endif %}{% endfor %}
      {% endif %}<br><br>
    {% endif %}</div>
  </div>

    <div class="row"><table class="img-selector span12" id="img-selector-1">
      <tbody>
      <tr>
        <td>
          <ul class="thumbnails connectedSortable selected-list" id="selected-list">
          </ul>
        </td>
        <td class="well thumbnails connectedSortable trash hidden-phone" id="trash-1">
          <p>Trash <i class="icon-trash"></i></p>
        </td>
      </tr>
      </tbody>
    </table></div>
    <input type="hidden" name="img_list" id="img_data">
    {% if '/question/' in request.GET.next %} {# case: we come from a question page and have added a product there#}
        <input type="submit" class="btn btn-primary" value="{% trans 'Save product' %}">
    {% elif not item %}
        <input type="submit" class="btn btn-primary" value="{% trans 'Create' %}"> {% trans "or" %} <button type="submit" class="btn" name="edit">{% trans 'Create and add features' %}</button>
    {% else %}
        <input type="submit" class="btn btn-primary" value="{% trans 'Update' %}">
    {% endif %}
    {% if next %}<input type="hidden" name="next" value="{{ next }}">{% elif request.GET.next %}<input type="hidden" name="next" value="{{ request.GET.next }}">{% endif %}
</form>

{% endblock %}

{% block extra_script %}
    {{ block.super }}
    <script type="text/javascript">
        pics = {{ img_album|safe }};
        results = {{ img_search|safe }};
        if (pics.length == 0) {
            pics.push.apply(pics, results);
        }
    </script>
    <script type="text/javascript">
    $(document).ready(function(){
    var item_form=document.getElementById("item_test");
    var is_item=item_form.getAttribute("data-item");
    var search_store=document.getElementById("search_store");
    var is_search_store=search_store.getAttribute("data-store");
    if (is_item =="1"){$(document).ready(function(){mixpanel.track("Load_edit_product");});};
    if (is_item =="0"){$(document).ready(function(){mixpanel.track("Load_add_product");});};
    if (is_search_store =="1"){$(document).ready(function(){mixpanel.track("Load_search_store");});};
    });
    </script>
<script type="text/javascript" src="{% static 'js/mixpanel_functions.js' %}"></script>
{% endblock %}
