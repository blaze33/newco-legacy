{# TITLE: Default #}

{% extends "site_base.html" %}

{% load url from future %}
{% load i18n %}
{% load bootstrap_tags %}
{% load form_utils %}
{% load staticfiles %}

{% block extra_style %}
  <link href="{{ STATIC_URL }}css/content.css" rel="stylesheet">
  {{ form.media.css }}
  {{ formset.media.css }}
  <style type="text/css">
    #div_id_items, #div_id_tags {
      display: none;
    }
  </style>
{% endblock %}

{% block head_title %}{% trans "Question" %}{% endblock %}

{% block body %}

<button class="btn btn-info pull-right" data-toggle="collapse" data-target="#div_tips"><i class="icon-info-sign icon-white"></i> {% trans "Tips" %}</button>
<h1>{% if not question %}{% trans "Ask a question" %}{% else %}{% trans "Edit your question" %}{% endif %}</h1>

<div class="row">
  <div class="span8">
    <br>
    <form class="form-horizontal" method="POST">{% csrf_token %}
      {{ form|as_bootstrap_question_form }}

      <div class="control-group{% if cb_answer %} invisible{% endif %}" id="submit-question">
        <div class="controls">
          <button class="btn btn-primary" name="add_question" type="submit" value="{{ statuses.public }}">{% if question.is_public %}{% trans "Update and keep public" %}{% elif question.is_draft %}{% trans "Update and publish" %}{% else %}{% trans "Publish your question" %}{% endif %}</button>
          <button class="btn" name="add_question" type="submit" value="{{ statuses.draft }}">{% if question.is_public %}{% trans "Unpublish and save as draft" %}{% elif question.is_draft %}{% trans "Update and keep as draft" %}{% else %}{% trans "Save as draft" %}{% endif %}</button>
        </div>
      </div>

      {% if formset %}
        <div class="control-group"><div class="controls">
          <button class="btn btn-mini btn-info pull-right" type="button" data-toggle="collapse" data-target="#div_tips"><i class="icon-info-sign icon-white"></i> {% trans "Why is it encouraged?" %}</button>
          <label class="checkbox">
            <input name="cb_answer" id="checkbox-answer" type="checkbox"{% if cb_answer %} checked{% endif %}>
            {% trans "Answer your own question" %}
          </label>
        </div></div>
        <div class="collapse {% if formset_errors or cb_answer %}in{% else %}out{% endif %}" id="answer_form">
          {{ formset.management_form }}
          {% for form in formset %}
            {{ form|as_bootstrap }}
          {% endfor %}
        </div>

        <div class="control-group{% if not cb_answer %} hidden{% endif %}" id="submit-both">
          <div class="controls">
            <button class="btn btn-primary" name="add_question" type="submit" value="{{ statuses.public }}">{% trans "Publish your question and answer" %}</button>
            <button class="btn" name="add_question" type="submit" value="{{ statuses.draft }}">{% trans "Save as draft" %}</button>
          </div>
        </div>
      {% endif %}

      <input type="hidden" name="next" {% if next %}value="{{ next }}"{% endif %}>
    </form>

    <div class="modal fade hide" id="itemModal" tabindex="-1" role="dialog" aria-labelledby="itemModalLabel" aria-hidden="true">
      <div class="modal-header">
        <a class="close" data-dismiss="modal" type="button" aria-hidden="true">&times;</a>
        <h3 id="itemModalLabel">{% trans "Add a product"%}{% trans ":" %}</h3>
      </div>
      <form class="form-horizontal">
        <div class="modal-body">{{ i_form|as_bootstrap }}</div>
        <div class="modal-footer">
          <a class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</a>
          <input class="btn btn-primary" name="add_item" id="add-item" type="button" value="{% trans 'Add product' %}">
        </div>
      </form>
    </div>

  </div>

  <div class="span4"><div class="collapse out" id="div_tips"><div class="well well-small">
    <p>{% blocktrans %}
      Here, you can ask a question about one or several products:
      <ol>
        <li>Write down your question.</li>
        <li>Select products or tags to bind that question to, using the search bars.</li>
        <li>Once the question submitted, you can wait for an answer or, if you are getting impatient, <b>ask an expert</b> to help you out.</li>
      </ol>
    {% endblocktrans %}</p>
    <hr>
    <p>{% trans "You can also answer your own question if there is something you would like to share and you haven't found the related question. That way, you document your knowledge so it can help others." %}</p>
  </div></div></div>
</div>

{% endblock %}

{% block extra_script %}
  {{ form.media.js }}
  {{ formset.media.js }}
  <script type="text/javascript">
    {% if show %}$("#itemModal").modal("show"){% endif %}
    $("#checkbox-answer").on("click", function (eventObject) {
        $("#answer_form").collapse("toggle")
        $("#submit-question").toggleClass("invisible")
        $("#submit-both").toggleClass("hidden")
    })

    var radioSelector = ":radio[name=parents]";

    $.showChecked = function () {
        var selectedValue = $(radioSelector + ":checked").val();
        if ( selectedValue ) {
            $("#div_id_" + selectedValue).fadeToggle();
        }
    };

    $.showChecked();
    $(radioSelector).on("click", function (eventObject) {
        $("#div_id_items, #div_id_tags").hide();
        $.showChecked();
    })

    $("#id_tags").select2($.select2TagsParameters);
    $("#id_item-tags").select2($.select2TagsParameters);

    function addProduct(term) {
        $("#id_items").select2("close");
        $("#id_tags").select2("close");
        $("#id_item-name").val(term);
        $('#itemModal').modal('show');
    };

    $("#id_items").select2($.extend({}, $.select2BaseParameters, {
        placeholder: "{% trans 'Search for a product' %}",
        maximumSelectionSize: "{{ form.max_products }}",
        formatNoMatches: function (term) {
            // return term + ' is not found. <button class="btn">Add it</button>'
            result = '<span><span id="tag_query">' + term + '</span> {% trans 'not found' %}</span>' +
                '<button class="btn tooltip-top" onclick="addProduct(\'' + term + '\')"' +
                'title="{% trans 'Click here if you cannot find the product you want to link your question to' %}">' +
                '<i class="icon-plus" rel="add_icon"></i> {% trans "Add a product" %}</button>'
            return result;
        },
        containerCssClass: 'select2-bootstrap',
    }));

    $(function() {
        $("#add-item").click(function(event) {
            event.preventDefault();
            $('#itemModal').modal('hide');
            $.ajax({
                type: "post",
                data: $("#itemModal form").serialize() + '&add_item=add_item',
                success: function(data, status, xhr) {
                    console.log(data);
                    $("#id_items").append('<option value=' + data.id+'>' + data.name+'</name>')
                        .select2("val", [].concat($("#id_items").val(), [String(data.id)]));
                    $('input[name="next"]').val(data.next);
                    $.displayMessages(data.messages);
                },
                error: function(xhr, status, error) {
                    console.log(xhr, status, error);
                }
            });
            return false;
        });
    });

    $(document).ready(function(){
        mixpanel.track("Load_add_question");
    });
  </script>
{% endblock %}
