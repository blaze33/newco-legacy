{# TITLE: Default #}

{% extends "site_base.html" %}

{% load url from future %}
{% load i18n %}
{% load bootstrap_tags %}
{% load form_utils %}
{% load staticfiles %}

{% block extra_style %}
  {{ form.media.css }}
  {{ formset.media.css }}
  <link href="{% static 'external/select2/select2.css' %}" rel="stylesheet">
  <style>
  #id_content {
    resize:vertical;
  }
  .select2-no-results button {
    float: right;
  }
  .select2-no-results > span {
    display: inline-block;
    padding: 5px 12px;
  }

  .select2-bootstrap .select2-choices {
    background-color: white;
    -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
    -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
    box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
    -webkit-transition: border linear .2s, box-shadow linear .2s;
    -moz-transition: border linear .2s, box-shadow linear .2s;
    -o-transition: border linear .2s, box-shadow linear .2s;
    transition: border linear .2s, box-shadow linear .2s;

    border-radius: 4px;
    border: 1px solid #CCC;
    background-image: none;
  }

  .select2-bootstrap.select2-container-active .select2-choices {
    border-color: rgba(82, 168, 236, 0.8);
    outline: 0;
    outline: thin dotted 9;
    -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(82, 168, 236, 0.6);
    -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(82, 168, 236, 0.6);
    box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(82, 168, 236, 0.6);
  }
  .select2-bootstrap.select2-dropdown-open .select2-choices {
    border-radius: 4px 4px 0 0;
  }

</style>
{% endblock %}

{% block head_title %}{% trans "Question" %}{% endblock %}

{% block body %}

<div>
  <span class="pull-right"><button class="btn btn-success" data-toggle="collapse" data-target="#div_tips"><i class="icon-info-sign icon-white"></i> {% trans "Tips" %}</button></span>
  <h1>{% if not question %}{% trans "Ask a question" %}{% else %}{% trans "Edit your question" %}{% endif %}</h1>
</div>

<div class="row">
  <div class="span8">
    <br>
    <form class="form-horizontal" method="POST">{% csrf_token %}
      {{ form|as_bootstrap_question_form }}

      <div class="control-group" id="div_submit_q"{% if cb_answer %} style="visibility: hidden;" {% endif %}>
        <div class="controls">
          <button type="submit" class="btn btn-primary" name="add_question" value="{{ status.public }}">{% if question.is_public %}{% trans "Update and keep public" %}{% elif question.is_draft %}{% trans "Update and publish" %}{% else %}{% trans "Publish your question" %}{% endif %}</button>
          <button type="submit" class="btn" name="add_question" value="{{ status.draft }}">{% if question.is_public %}{% trans "Unpublish and save as draft" %}{% elif question.is_draft %}{% trans "Update and keep as draft" %}{% else %}{% trans "Save as draft" %}{% endif %}</button>
        </div>
      </div>

      {% if formset %}
        <div class="control-group"><div class="controls">
          <span class="pull-right">
            <button class="btn btn-mini btn-success" type="button" data-toggle="collapse" data-target="#div_tips"><i class="icon-info-sign icon-white"></i> {% trans "Why is it encouraged?" %}</button>
          </span>
          <label class="checkbox">
            <input type="checkbox" name="cb_answer" data-toggle="collapse" data-target="#answer_form"{% if cb_answer %} checked{% endif %}>
            {% trans "Answer your own question" %}
          </label>
        </div></div>
        <div id="answer_form" class="row collapse {% if formset_errors or cb_answer %}in{% else %}out{% endif %}"><div class="span7">
          {{ formset.management_form }}
          {% for form in formset %}
            {{ form|as_bootstrap }}
          {% endfor %}
        </div></div>
        <div class="control-group" id="div_submit_qa"{% if not cb_answer %} style="display: none;"{% endif %}>
          <div class="controls">
            <button type="submit" class="btn btn-primary" name="add_question" value="{{ status.public }}">{% trans "Publish your question and answer" %}</button>
            <button type="submit" class="btn" name="add_question" value="{{ status.draft }}">{% trans "Save as draft" %}</button>
          </div>
        </div>
      {% endif %}

      {% if next %}<input type="hidden" name="next" value="{{ next }}">{% endif %}

      <div class="modal fade hide" id="itemModal" tabindex="-1" role="dialog" aria-labelledby="itemModalLabel" aria-hidden="true">
        <div class="modal-header">
          <a type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</a>
          <h3 id="itemModalLabel">{% trans "Add a product"%}{% trans ":" %}</h3>
        </div>
        <div class="modal-body">{{ i_form|as_bootstrap }}</div>
        <div class="modal-footer">
          <a class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</a>
          <input type="submit" class="btn btn-primary" name="add_item" value="{% trans 'Add product' %}">
        </div>
      </div>

    </form>
  </div>

  <div class="span4"><div class="collapse out" id="div_tips"><div class="well well-small">
    <p>{% blocktrans %}
      Here, you can ask a question about one or several products:
      <ol>
        <li>Write down your question.</li>
        <li>Select products or tags to bind that question to, using the search bars.</li>
        <li>Once the question submitted, you can wait for an answer or, if you are getting impatient, <b>ask an expert</b> to help you out.</li>
      </ol>
    {% endblocktrans %}</p>
    <hr>
    <p>{% trans "You can also answer your own question if there is something you would like to share and you haven't found the related question. That way, you document your knowledge so it can help others." %}</p>
  </div></div></div>
</div>

{% endblock %}

{% block extra_script %}
  {{ form.media.js }}
  {{ formset.media.js }}
  <script type="text/javascript">
    {% if show %}$("#itemModal").modal("show"){% endif %}
    $('#answer_form').on('hide', function () {
      $('#div_submit_q').css('visibility','visible');
      $('#div_submit_qa').css('display','none');
    })
    $('#answer_form').on('show', function () {
      $('#div_submit_q').css('visibility','hidden');
      $('#div_submit_qa').css('display','inline');
    })

    function hide_tags_show_items() {
      $('#div_id_items').css('opacity','1');
      $('#div_id_tags').css('opacity','0.5');
    }
    function hide_items_show_tags() {
      $('#div_id_items').css('opacity','0.5');
      $('#div_id_tags').css('opacity','1');
    }

    if($("#id_parents_1").is(":checked")){hide_tags_show_items();}
    if($("#id_parents_2").is(":checked")){hide_items_show_tags();}
    $('#id_parents_1').click(function () {hide_tags_show_items();})
    $('#id_parents_2').click(function () {hide_items_show_tags();})

    $(document).ready(function(){
        mixpanel.track("Load_add_question");
    });
  </script>
  <script src="{% static 'external/select2/select2.js' %}"></script>
  <script>
    var select2TagsParameters = {
      placeholder: "Search for a tag",
      multiple:true,
      minimumInputLength: 2,
      initSelection: function (element, callback) {
              // reload tags
              var data = [];
              $(element.val().split(",")).each(function () {
                data.push({id: this, text: this});
              });
              callback(data);
            },
      createSearchChoice:function(term, data) {
        if ($(data).filter(function() { return this.text.localeCompare(term)===0; }).length===0) {
          return {id:term, text:term};
        }
      },
      ajax: {
        url: '{% url "redis" "tag" %}',
        dataType: 'json',
        quietMillis: 100,
        data: function (term, page) { // page is the one-based page number tracked by Select2
          return {
                q: term, //search term
                limit: 20, // page size
              };
        },
        results: function (data, page) {
          $.each(data, function(i){
            data[i].id = data[i].name;
            data[i].text = data[i].name;
          });
          console.log(data);
          var more = (page * 10) < data.total; // whether or not there are more results available
          // notice we return the value of more so Select2 knows if more results can be loaded
          return {results: data, more: more};
        }
      },
      containerCssClass: 'select2-bootstrap',
    };

  $("#id_tags").select2(select2TagsParameters);
  $("#id_item-tags").select2(select2TagsParameters);

function addProduct(term) {
  $("#id_items").select2("close");
  $("#id_tags").select2("close");
  $("#id_item-name").val(term);
  $('#itemModal').modal('show');
};

$("#id_items").select2({
  placeholder: "Search for an item",
  formatNoMatches: function (term) {
              // return term + ' is not found. <button class="btn">Add it</button>'
              result =  '<span><span id="tag_query">' + term + '</span> not found</span>' +
                        '<button class="btn tooltip-top" onclick="addProduct(\''+term+'\')"' +
                        'title="{% trans 'Click here if you can&#39;t find the product you want to link your question to' %}">' +
                        '<i rel="add_icon" class="icon-plus"></i> {% trans "Add a product" %}</button>'
              return result;
            },
  containerCssClass: 'select2-bootstrap',
});
  </script>
{% endblock %}
