{% extends "site_base.html" %}

{% load url from future %}
{% load i18n %}
{% load voting_tags %}
{% load voting_utils %}
{% load content_utils %}
{% load staticfiles %}
{% load bootstrap_tags %}

{% block extra_style %}
    {{ block.super }}

    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/content.css">
    {% if question %}{{ question.answer_form.media.css }}{% endif %}
{% endblock %}

{% block head_title %}{{ question.content }}{% endblock %}

{% block body %}

{% vote_by_user user on question as vote %}
{% score_for_object question as score %}

<div class="row">
    <div class="span7" itemscope itemtype="http://schema.org/Article">
        <div class="row one_row" id="q-{{ question.id }}">
            <div class="span1"><h2 class="right">{% if score %}{{ score.score }}{% else %}0{% endif %}{% vote_form question vote %}</h2></div>
            <div class="span4"><h2>
                <a href="{% url 'item_detail' 'question' question.id 'ROOO' %}" itemprop="url"><span itemprop="name">{{ question.content }}</span></a>
                {% if user.is_superuser or question.author == request.user %}
                    {% with name=question|to_class_name %}{% edit name question.id %}{% endwith %}
                {% endif %}
            </h2></div>
            <div class="span2 right">{% include "items/_author.html" with object=question %}</div>
        </div>
        {% votes_by_user user on question.answer_set.all as answer_vote_dict %}
        {% scores_for_objects question.answer_set.all as answer_score_dict %}

        {% for answer in question.answer_set.all %}{% if answer.is_public %}
            {% dict_entry_for_item answer from answer_vote_dict as vote %}
            {% dict_entry_for_item answer from answer_score_dict as score %}
            <div class="row one_row" id="a-{{ answer.id }}" rel="popover">
                <div class="span1"><h3 class="right">{% if score %}{{ score.score }}{% else %}0{% endif %}{% vote_form answer vote %}</h3></div>
                <div class="span4"><p><span itemprop="description"{# Seb: I took 1 question as an "article"/"name" and answers as "description" for SEO/schema.org ... maybe it s not the best ... #}>
                    {% autoescape off %}{{ answer.content }}{% endautoescape %}</span>
                    {% if user.is_superuser or answer.author == request.user %}
                        {% with name=answer|to_class_name %}{% edit name answer.id %}{% endwith %}
                    {% endif %}
                </p></div>
                <div class="span2 right">{% include "items/_author.html" with object=answer %}</div>
            </div>
        {% endif %}{% endfor %}

        <div class="row"><div class="span6 offset1">
            <div class="block_controls">
                <button class="btn btn-mini" data-toggle="collapse" data-target="#answer_form"><i class="icon-share-alt"></i> {% if question.answer_set.all %}{% trans "Add a better answer" %}{% else %}{% trans "Answer this question" %}{% endif %}</button>
                &nbsp;&nbsp;&nbsp;
                <button class="btn btn-mini" data-toggle="modal" data-target="#ask"><i class="icon-user"></i> {% trans "Ask someone to answer" %}</button>
            </div>
            <br />
            <div id="answer_form" class="collapse {% if question.answer_form.errors %}in{% else %}out{% endif %}"><form method="POST" action="#answer_form">
                {% csrf_token %}
                {{ question.answer_form|as_bootstrap }}
                <button type="submit" class="btn btn-mini" name="answer"><i class="icon-share-alt"></i> {% trans "Answer" %}</button>
                <input type="hidden" name="question_id" value="{{ question.id }}"/>
            </form></div>
        </div></div>
        {% include "items/_ask_modal.html" %}
    </div>

    <div class="offset1 span3">
        <div class="row well well-small">
            <h3>{% trans "Related Products" %}:</h3>
            <br>
            <div id="thumbnails_list">{% for item in question.items.all %}
                {% include "profiles/_thumbnail_frame.html" with object=item only %}
            {% endfor %}</div>
        </div>

        <hr>

        {% for title, content_list in related_questions.iteritems %}
            {% if content_list %}<div class="row well">
                <h3>{{ title }}</h3>
                <ul>{% for content in content_list %}<li><a href="{{ content.get_absolute_url }}">{{ content.content }}</a></li>{% endfor %}</ul>
            </div>{% endif %}
        {% endfor %}
    </div>
</div>
{% endblock %}


{% block extra_body_base %}
    {{ block.super }}
    <script src="{% static "js/content.js" %}"></script>
    {% if question %}{{ question.answer_form.media.js }}{% endif %}
{% endblock %}
