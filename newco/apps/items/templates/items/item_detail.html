{% extends "site_base.html" %}

{% load i18n %}
{% load url from future %}
{% load content_utils %}
{% load format_utils %}
{% load staticfiles %}

{% block extra_style %}
  <link rel="stylesheet" href="{{ STATIC_URL }}external/bootstrap-image-gallery/css/bootstrap-image-gallery.min.css">
  <link rel="stylesheet" href="{{ STATIC_URL }}css/content.css">
  <link rel="stylesheet" href="{{ STATIC_URL }}css/partial_question_form.css">
  <link rel="stylesheet" href="{{ STATIC_URL }}css/affiliation.css">
  <link rel="stylesheet" href="{{ STATIC_URL }}css/help.css">
  {{ media.css }}
{% endblock %}

{% block head_title %}{{ item.name }}{% endblock %}

{% block body %}
<div class="row no-left-margin">
  {% include "items/_data_sheet.html" %}
</div>
<hr>
<div class="row">
  <div class="span9">
    {% if questions %}
      {% include "items/feed_display/_content_list.html" with contents=questions display="text" display_ctx="False" display_img="False" display_a="no" disp_exp="False" displ_sign="True" display_q_form="True" question_form=question_form item=item user=user path=request.path experts=experts csrf_token=csrf_token empty_msg=empty_msg scores=scores votes=votes only %}
    {% else %}
      {% include "items/_partial_question_form.html" with contents=questions question_form=question_form csrf_token=csrf_token only %}
    {% endif %}
    <br><br><br>
    <hr>
    {% for prod in store_products %}
      {% if forloop.first %}
        <h3>{% trans "Where to buy" %}</h3>
        <div class="row" id="prices">
          <div class="span2"><h4>{% trans "Store" %}</h4></div>
          <div class="span4"><h4>{% trans "Name" %}</h4></div>
          <div class="span1"><h4>{% trans "Price" %}</h4></div>
        </div>
      {% endif %}
      <hr>
      {% include "affiliation/_affiliation_item.html" with prod=prod display="list" %}
    {% endfor %}

    <hr>

    <a class="btn" href="{% url 'item_edit' item|to_class_name item.id %}"><i class="icon-edit"></i> {% trans "Edit Product" %}</a>
    {% if user.is_superuser %}<a class="btn" href="{% url 'item_delete' item|to_class_name item.id %}"><i class="icon-trash"></i> {% trans "Delete Product" %}</a>{% endif %}
  </div>

  <div class="span3">
    <br>
    {% if store_products %}
      <div class="dropdown controls">
        <a class="btn btn-large dropdown-toggle" id="drop" role="button" data-toggle="dropdown" data-target="#" data-name="{{ item.name }}">{% trans "From" %} <b>{% price cheapest.price cheapest.currency LANGUAGE_CODE %}</b> <span class="caret"></span></a>
        <ul class="dropdown-menu input-large" role="menu" aria-labelledby="drop">
          {% for prod in store_products %}
            {% include "affiliation/_affiliation_item.html" with prod=prod display="dropdown" %}
            <li class="divider"></li>
          {% endfor %}
          <li><a href="#prices">{% trans "See the detailed offers" %} <i class="icon-chevron-right"></i></a></li>
        </ul>
      </div>
    <hr>
    {% endif %}
    {% for tag, top_question in top_question_by_tag.iteritems %}
      <div class="span3 well well-small nc-right-col-well-span4" style="margin-left: 0">
        <h5><a class="black" href="{% url 'tagged_items' tag.slug 'questions' %}" class="black">{% trans "Top Questions for tag" %}</a> <a class="label" href="{% url 'tagged_items' tag.slug %}" class="black">{{ tag.name|truncatechars:20 }}</a></h5>
        {% for question in top_question %}
          <a href="{{ question.get_absolute_url }}" class="black">{{ question.content|truncatechars:70 }}</a>
        {% endfor %}
      </div>
    {% endfor %}

    <div class="span3 well well-small nc-right-col-well-span4 top-products" style="margin-left: 0">
        <h3>{% trans "Top related products" %}</h3>
        {% for tag, product_list in top_products_by_tag.iteritems %}
        <hr>
          <div class="row">
      	    <div class="span3">
      	      <div class="span1" style="margin-left: 0">
      		    <h5><a class="label" href="{% url 'tagged_items' tag.slug %}">{{ tag.name|truncatechars:20 }}</a></h5>
      	      </div>
      	      {% if product_list %}
                {% for item in product_list %}
                  <div class="span2 content-product-related">
                    {% include "items/feed_display/_image.html" with image=item.image %}
                    <br><a href="{{ item.get_absolute_url }}"><h6 class="black" align="center">{{ item.name|truncatechars:15 }}</h6></a>
                  </div>
                {% endfor %}
             <!-- ###### Todo: Surement l'enlever completement du well ##### -->
              {% else %}
              <div class="span2 no-product-related">{% trans "No related product" %}</div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
    </div>
    {% comment %}
    <div class="span3 well well-small nc-right-col-well-span4 top-products" style="margin-left: 0">
      {% if top_products_by_tag %}
        <h3>{% trans "Top related products" %}</h3>
        {% for tag, product_list in top_products_by_tag.iteritems %}
          {% if product_list %}
          <hr>
            <div class="span2" style="margin-left: 0">
              <h5>{% trans "In" %} <a class="label" href="{% url 'tagged_items' tag.slug %}">{{ tag.name|truncatechars:15 }}</a>:</h5>
      	    </div>
            <div class="row" id="thumbnails_list">
      	      <div class="span3">
                {% for item in product_list %}
                  <div class="span3 content-product-related">
                    {% include "items/feed_display/_image.html" with content=item image=item.image %}
                    <br><a href="{{ item.get_absolute_url }}"><h6 class="black" align="center">{{ item.name|truncatechars:15 }}</h6></a>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>
    {% endcomment %}
  </div>
</div>
{% endblock %}

{% block extra_body %}
<!-- modal-gallery is the modal dialog used for the image gallery -->
<div class="modal modal-gallery hide fade" id="modal-gallery" tabindex="-1">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">&times;</a>
    <h3 class="modal-title"></h3>
  </div>
  <div class="modal-body"><div class="modal-image"></div></div>
  <div class="modal-footer">
    <a class="btn btn-success modal-play modal-slideshow" data-slideshow="2000" title="Play"><i class="icon-play icon-white"></i></a>
    <a class="modal-download" target="_blank">{% trans "Source:" %} <span>{% trans "Download" %}</span></a>
  </div>
</div>

{% include "help/_ask_modal.html" %}

{% endblock %}

{% block extra_script %}
  <script src="{% static 'js/ga_functions.js' %}"></script>
  <script src="{{ STATIC_URL }}external/javascript-load-image/load-image.min.js"></script>
  <script src="{% static 'external/bootstrap-image-gallery/js/bootstrap-image-gallery.min.js' %}"></script>
  <script src="{% static 'js/content.js' %}"></script>
  {{ media.js }}
  <script src="{% static 'js/help.js' %}"></script>
  <script src="{{ STATIC_URL }}js/partial_question_form.js"></script>
  <script>
    $(function() {
        if ( '{{ ask_form.errors }}' ) { $("#modal-ask").modal("show"); }
        if ( '{{ question_form.errors }}' ) { $("#question-form").collapse("show"); }
    });
  </script>
  <script src="{{ STATIC_URL }}js/follow.js"></script>
  <script>
    //Tracking Product name for analytics
    $(document).ready(function(){
      var product=document.getElementById("drop");
      var name=product.getAttribute("data-name");
      mixpanel.track("Load_item_detail", {"product":name});
      if ($('div').hasClass('alert-success')){mixpanel.track("Event Success on Item Page");};
    });
     // Start slideshow button:
    $('#start-slideshow').button().click(function () {
        var options = $(this).data(),
            modal = $(options.target),
            data = modal.data('modal');
        if (data) {
            $.extend(data.options, options);
        } else {
            options = $.extend(modal.data(), options);
        }
        modal.find('.modal-slideshow').find('i')
            .removeClass('icon-play')
            .addClass('icon-pause');
        modal.modal(options);
    });
  </script>
{% endblock %}
