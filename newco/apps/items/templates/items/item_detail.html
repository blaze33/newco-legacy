{% extends "site_base.html" %}

{% load i18n %}
{% load url from future %}
{% load content_utils %}
{% load format_utils %}
{% load staticfiles %}

{% block extra_style %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/content.css">
  {{ media.css }}
{% endblock %}

{% block head_title %}{{ item.name }}{% endblock %}

{% block body %}

<div class="row"><div class="span12"><ul class="thumbnails">
  {% for image in album|slice:":4" %}<li class="span3">
    <a class="thumbnail" href="{{ image.data.contextLink }}" target="_blank">
      <img src="{{ image.data.thumbnailLink }}" alt="{{ image.data.snippet }}" height="128px">
    </a>
  </li>{% endfor %}
</ul></div></div>

</br>

<div class="row">
  <div class="span7">
    {% include "items/_data_sheet.html" %}
    <br>

    <div class="row tabbable">
      <ul class="nav nav-tabs">
        <li{% if 'link' not in request.GET and 'feature' not in request.GET and 'story' not in request.GET %} class="active"{% endif %}><a href="#questions" data-toggle="tab">{% trans "Questions" %}</a></li>
        <li{% if 'link' in request.GET %} class="active"{% endif %}><a href="#links" data-toggle="tab">{% trans "Links" %}</a></li>
        <li{% if 'feature' in request.GET %} class="active"{% endif %}><a href="#features" data-toggle="tab">{% trans "Features" %}</a></li>
        <li{% if 'story' in request.GET %} class="active"{% endif %}><a href="#stories" data-toggle="tab">{% trans "Stories" %}</a></li>
      </ul>

      <div class="tab-content" style="overflow: visible;">
        <div id="questions" class="tab-pane{% if 'link' not in request.GET and 'feature' not in request.GET and 'story' not in request.GET %} active{% endif %} nc_qna_list_div">{% include "items/_question_list.html" %}</div>
        <div id="links" class="tab-pane{% if 'link' in request.GET %} active{% endif %}">{% include "items/_link_list.html" %}</div>
        <div id="features" class="tab-pane{% if 'feature' in request.GET %} active{% endif %}">{% include "items/_feature_list.html" %}</div>
        <div id="stories" class="tab-pane{% if 'story' in request.GET %} active{% endif %}">
          <div class="span7">
            <h3>Soon you'll be able to tell us a nice story about this product</h3>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus erat diam, convallis et convallis vel, pharetra vel nulla. Aliquam ac tellus a purus mollis posuere. Etiam interdum dictum sapien eu condimentum. Fusce commodo pellentesque diam et mollis. Nulla et purus nunc, non placerat lacus. Phasellus elementum fermentum tortor vel porttitor. Nunc cursus, turpis eu malesuada pharetra, velit lacus interdum ipsum, ac venenatis turpis dolor at augue. Vestibulum tellus risus, interdum vitae fringilla nec, iaculis vel metus.
            <ul class="thumbnails">
                <li class="span3"><a class="thumbnail" href="#">
                  <img src="http://lorempixel.com/g/260/180" alt="">
                </a></li>
                <li class="span3"><a class="thumbnail" href="#">
                  <img src="http://lorempixel.com/g/260/180/technics" alt="">
                </a></li>
            </ul>
            Etiam interdum dictum sapien eu condimentum. Fusce commodo pellentesque diam et mollis. Nulla et purus nunc, non placerat lacus. Phasellus elementum fermentum tortor vel porttitor.
            </p>
            <hr>
          </div>
        </div>
      </div>
    </div>

    {% if store_prods_by_ean %}{% with nb_ean=store_prods_by_ean|length %}<div class="row" id="prices">
      <h3>{% trans "Where to buy" %}</h3>
      <div class="row">
        {% if nb_ean != 1 %}<div class="span1"><h4>{% trans "EAN" %}</h4></div>{% endif %}
        <div class="span2"><h4>{% trans "Store" %}</h4></div>
        <div class="span{% if nb_ean == 1 %}4{% else %}3{% endif %}"><h4>{% trans "Name" %}</h4></div>
        <div class="span1"><h4>{% trans "Price" %}</h4></div>
      </div>
      {% for ean, prod_list in store_prods_by_ean.items %}{% for prod in prod_list %}
        <hr>
        <div class="row">
          {% if nb_ean != 1 %}<div class="span1">{{ ean }}</div>{% endif %}
          <div class="span2"><a href="{{ prod.store.url }}" target="_blank" class="black">{% with "https://getfavicon.appspot.com/"|add:prod.store.url as icon_url %}<img src="{{ icon_url }}" height="16px" width="16px">&nbsp;{{ prod.store }}{% endwith %}</a></div>
          <div class="span{% if nb_ean == 1 %}4{% else %}3{% endif %}">{{ prod.name }}</div>
          <div class="span1"><a href="{{ prod.url }}" target="_blank">{% price prod.price prod.currency LANGUAGE_CODE %}</a></div>
        </div>
      {% endfor %}{% endfor %}
      <hr>
    </div>{% endwith %}{% endif %}

    <div class="row">
      <a class="btn" href="{% url 'item_edit' item|to_class_name item.id %}"><i class="icon-edit"></i> {% trans "Edit Item" %}</a>
      {% if user.is_superuser %}<a class="btn" href="{% url 'item_delete' item|to_class_name item.id %}"><i class="icon-trash"></i> {% trans "Delete Item" %}</a>{% endif %}
    </div>
  </div>

  <div class="offset2 span3">{% if store_prods_by_ean %}
    <div class="dropdown controls">
      <a class="btn btn-large dropdown-toggle" id="drop" role="button" data-toggle="dropdown" data-target="#">{% trans "From" %} <b>{% price cheapest_prod.price currency=cheapest_prod.currency language_code=LANGUAGE_CODE %}</b> <span class="caret"></span></a>
      <ul class="dropdown-menu input-large" role="menu" aria-labelledby="drop">
        {% for ean, prod_list in store_prods_by_ean.items %}{% for prod in prod_list %}
          {% with "https://getfavicon.appspot.com/"|add:prod.store.url as icon_url %}<li><a href="{{ prod.url }}" target="_blank"><img src="{{ icon_url }}" height="16px" width="16px">&nbsp;{{ prod.store }}&nbsp;&nbsp; {% price prod.price prod.currency LANGUAGE_CODE %}</a></li>{% endwith %}
        {% endfor %}<li class="divider"></li>{% endfor %}
        <li><a href="#prices">{% trans "See the detailed offers" %} <i class="icon-chevron-right"></i></a></li>
      </ul>
    </div>

    <hr>

    <h4>{% trans "Where to buy" %}</h4>
    <div>{% for ean, prod_list in store_prods_by_ean.items %}{% for prod in prod_list %}
      {% include "affiliation/_affiliation_item.html" with prod=prod %}
    {% endfor %}{% endfor %}</div>

  {% endif %}</div>
</div>

{% endblock %}

{% block extra_body_base %}
  {{ block.super }}
  <script src="{% static 'js/content.js' %}"></script>
  {{ media.js }}
  <script type="text/javascript"> // script can't go to '/static' : needs to translate text
      $(document).ready( function() {
          var form = $('#question_form');
          var icon_change = $('[rel=add_icon]');
          var text_change = $('[rel=add_q_text]');
          var text_change_no_q_yet = $('[rel=add_q_text_no_q_yet]');
          form.on('shown', function () {
              icon_change.removeClass('icon-plus').addClass('icon-remove');
              text_change.html("&nbsp;");
              text_change_no_q_yet.html("{% trans 'Ask a new question:' %}");
              $('#id_content').focus();
          })
          form.on('hidden', function () {
              icon_change.removeClass('icon-remove').addClass("icon-plus");
              text_change.html("{% trans 'Ask a new question!' %}");
              text_change_no_q_yet.html("{% trans 'No question yet! Ask the first one here!' %}");
          })
      });
  </script>

  <script type="text/javascript">
      $(document).ready( function() {
          var divCollection = $("#[id^='answer\_form\_']");
          $.each(divCollection, function (i, item) {
              var bc = $("#controls_" + $(this)[0].id)
              var icon_change = $('[rel=icon]', bc);
              var text_change = $('[rel=text]', bc);
              $(this).on('shown', function () {
                  icon_change.removeClass('icon-share-alt').addClass('icon-remove');
                  text_change.html("{% trans 'Close' %}");
              })
              $(this).on('hidden', function () {
                  icon_change.removeClass('icon-remove').addClass('icon-share-alt');
                  text_change.html("{% trans 'Add an answer' %}");
              })
          })
      });
  </script>
{% endblock %}
